<!DOCTYPE html>
<html class="light" lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LiveGalGame - 总览</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:ital,wght@0,200..800;1,200..800&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
  <script>
    tailwind.config = {
      darkMode: "class",
      theme: {
        extend: {
          colors: {
            "primary": "#c51662",
            "background-light": "#f8f6f7",
            "background-dark": "#211118",
            "text-light": "#1b0e14",
            "text-dark": "#f8f6f7",
            "text-muted-light": "#974e6e",
            "text-muted-dark": "#a88fa0",
            "surface-light": "#ffffff",
            "surface-dark": "#2a161f",
            "border-light": "#f3e7ec",
            "border-dark": "#402634",
            "primary-subtle-light": "#f3e7ec",
            "primary-subtle-dark": "#402634",
            "success": "#22c55e",
            "warning": "#f59e0b",
            "error": "#ef4444",
          },
          fontFamily: {
            "display": ["Plus Jakarta Sans", "'Noto Sans SC'", "sans-serif"]
          },
          borderRadius: {
            "DEFAULT": "1rem",
            "lg": "1.5rem",
            "xl": "2rem",
            "full": "9999px"
          },
          backgroundImage: {
            'sakura-pattern': "url(\"data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23c51662' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E\")",
          }
        },
      },
    }
  </script>
  <style>
    .material-symbols-outlined {
      font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24;
      font-size: 24px;
    }
  </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark bg-sakura-pattern">
  <div class="relative flex min-h-screen w-full">
    <!-- 左侧导航栏 -->
    <aside class="flex h-screen w-64 flex-col justify-between bg-gradient-to-b from-[#d81b60] to-[#8e24aa] p-4 text-white sticky top-0">
      <div class="flex flex-col gap-6">
        <!-- Logo -->
        <div class="flex items-center gap-3 px-2">
          <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10"
               style="background-color: #ffffff; background-image: url('data:image/svg+xml,<svg xmlns=\"http://www.w3.org/2000/svg\" viewBox=\"0 0 24 24\" fill=\"%23c51662\"><path d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z\"/></svg>');"></div>
          <div class="flex flex-col">
            <h1 class="text-white text-base font-bold leading-normal">LiveGalGame</h1>
            <p class="text-white/80 text-sm font-normal leading-normal">对话管理器</p>
          </div>
        </div>

        <!-- 导航菜单 -->
        <nav class="flex flex-col gap-2">
          <a class="nav-item flex items-center gap-3 px-3 py-2 rounded bg-white/20 text-white" href="#" data-page="overview">
            <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">dashboard</span>
            <p class="text-sm font-medium leading-normal">总览</p>
          </a>
          <a class="nav-item flex items-center gap-3 px-3 py-2 rounded text-white/80 hover:bg-white/10 transition-colors" href="./characters.html" data-page="characters">
            <span class="material-symbols-outlined">groups</span>
            <p class="text-sm font-medium leading-normal">攻略对象</p>
          </a>
          <a class="nav-item flex items-center gap-3 px-3 py-2 rounded text-white/80 hover:bg-white/10 transition-colors" href="./conversation-editor.html" data-page="conversations">
            <span class="material-symbols-outlined">history</span>
            <p class="text-sm font-medium leading-normal">历史对话</p>
          </a>
          <a class="nav-item flex items-center gap-3 px-3 py-2 rounded text-white/80 hover:bg-white/10 transition-colors" href="./settings.html" data-page="settings">
            <span class="material-symbols-outlined">settings</span>
            <p class="text-sm font-medium leading-normal">设置</p>
          </a>
        </nav>
      </div>
    </aside>

    <!-- 主内容区 -->
    <main class="flex-1 p-8">
      <div class="mx-auto max-w-5xl">
        <!-- 欢迎标题 -->
        <header class="mb-8">
          <h1 class="text-text-light dark:text-text-dark text-4xl font-black leading-tight tracking-[-0.033em]">欢迎回来！</h1>
          <p class="text-text-muted-light dark:text-text-muted-dark text-base font-normal leading-normal">这是您的对话项目快照。</p>
        </header>

        <!-- 统计卡片 -->
        <div class="mb-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-4" id="statistics-container">
          <!-- 统计数据将从数据库加载 -->
          <div class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <p class="mt-4 text-text-muted-light dark:text-text-muted-dark">加载中...</p>
          </div>
        </div>

        <!-- 最近对话标题 -->
        <div class="mb-6">
          <div class="flex items-center justify-between gap-4 mb-2">
            <h2 class="text-2xl font-bold text-text-light dark:text-text-dark">最近对话</h2>
            <div class="flex items-center gap-2">
              <button id="btn-show-hud" class="btn-hud flex min-w-[84px] items-center justify-center gap-2 overflow-hidden rounded-full h-11 px-5 border border-primary text-primary text-sm font-bold leading-normal tracking-[0.015em] hover:bg-primary-subtle-light/50 dark:hover:bg-primary-subtle-dark/50 transition-colors">
                <span class="material-symbols-outlined text-base">support_agent</span>
                <span class="truncate">实时助手</span>
              </button>
              <button class="btn-new-conversation flex min-w-[84px] items-center justify-center gap-2 overflow-hidden rounded-full h-11 px-5 bg-primary text-white text-sm font-bold leading-normal tracking-[0.015em] hover:opacity-90 transition-opacity">
                <span class="material-symbols-outlined text-base">add</span>
                <span class="truncate">新对话</span>
              </button>
            </div>
          </div>
          <p class="text-text-muted-light dark:text-text-muted-dark text-sm mb-4">"我"与攻略对象的聊天记录摘要。</p>
        </div>

        <!-- 最近对话列表 -->
        <div class="grid grid-cols-1 gap-6 md:grid-cols-2 lg:grid-cols-3" id="conversations-container">
          <!-- 对话数据将从数据库加载 -->
          <div class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
            <p class="mt-4 text-text-muted-light dark:text-text-muted-dark">加载中...</p>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="./js/renderer.js"></script>
  <script>
    // 加载统计数据
    async function loadStatistics() {
      try {
        if (window.electronAPI && window.electronAPI.getStatistics) {
          const stats = await window.electronAPI.getStatistics();
          renderStatistics(stats);
        } else {
          console.error('Database API not available');
          document.getElementById('statistics-container').innerHTML = '<p class="text-red-500">数据库API不可用</p>';
        }
      } catch (error) {
        console.error('Failed to load statistics:', error);
        document.getElementById('statistics-container').innerHTML = '<p class="text-red-500">加载失败：' + error.message + '</p>';
      }
    }

    // 渲染统计数据
    function renderStatistics(stats) {
      const container = document.getElementById('statistics-container');
      container.innerHTML = `
        <div class="stat-card flex items-start gap-4 rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-5 shadow-sm">
          <div class="stat-icon flex size-12 items-center justify-center rounded-lg bg-primary-subtle-light dark:bg-primary-subtle-dark text-primary">
            <span class="material-symbols-outlined text-3xl">groups</span>
          </div>
          <div>
            <p class="stat-label text-sm font-medium text-text-muted-light dark:text-text-muted-dark">攻略对象</p>
            <p class="stat-value text-3xl font-bold text-text-light dark:text-text-dark">${stats.characterCount}</p>
          </div>
        </div>
        <div class="stat-card flex items-start gap-4 rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-5 shadow-sm">
          <div class="stat-icon flex size-12 items-center justify-center rounded-lg bg-primary-subtle-light dark:bg-primary-subtle-dark text-primary">
            <span class="material-symbols-outlined text-3xl">chat_bubble</span>
          </div>
          <div>
            <p class="stat-label text-sm font-medium text-text-muted-light dark:text-text-muted-dark">对话</p>
            <p class="stat-value text-3xl font-bold text-text-light dark:text-text-dark">${stats.conversationCount}</p>
          </div>
        </div>
        <div class="stat-card flex items-start gap-4 rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-5 shadow-sm">
          <div class="stat-icon flex size-12 items-center justify-center rounded-lg bg-primary-subtle-light dark:bg-primary-subtle-dark text-primary">
            <span class="material-symbols-outlined text-3xl">account_tree</span>
          </div>
          <div>
            <p class="stat-label text-sm font-medium text-text-muted-light dark:text-text-muted-dark">消息</p>
            <p class="stat-value text-3xl font-bold text-text-light dark:text-text-dark">${stats.messageCount}</p>
          </div>
        </div>
        <div class="stat-card flex items-start gap-4 rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark p-5 shadow-sm">
          <div class="stat-icon flex size-12 items-center justify-center rounded-lg bg-primary-subtle-light dark:bg-primary-subtle-dark text-primary">
            <span class="material-symbols-outlined text-3xl">favorite</span>
          </div>
          <div>
            <p class="stat-label text-sm font-medium text-text-muted-light dark:text-text-muted-dark">平均好感度</p>
            <p class="stat-value text-3xl font-bold text-text-light dark:text-text-dark">${stats.avgAffinity}</p>
          </div>
        </div>
      `;
    }

    // 加载最近对话
    async function loadRecentConversations() {
      try {
        if (window.electronAPI && window.electronAPI.getRecentConversations) {
          const conversations = await window.electronAPI.getRecentConversations(10);
          renderConversations(conversations);
        } else {
          console.error('Database API not available');
          document.getElementById('conversations-container').innerHTML = '<p class="text-red-500">数据库API不可用</p>';
        }
      } catch (error) {
        console.error('Failed to load conversations:', error);
        document.getElementById('conversations-container').innerHTML = '<p class="text-red-500">加载失败：' + error.message + '</p>';
      }
    }

    // 渲染对话列表
    function renderConversations(conversations) {
      const container = document.getElementById('conversations-container');
      
      if (conversations.length === 0) {
        container.innerHTML = `
          <div class="col-span-full text-center py-12">
            <p class="text-text-muted-light dark:text-text-muted-dark mb-4">还没有对话记录</p>
            <a href="./conversation-editor.html" class="inline-flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-full hover:opacity-90 transition-opacity">
              <span class="material-symbols-outlined">add</span>
              创建第一个对话
            </a>
          </div>
        `;
        return;
      }

      container.innerHTML = conversations.map(conv => {
        const date = new Date(conv.updated_at);
        const daysAgo = Math.floor((Date.now() - date.getTime()) / (1000 * 60 * 60 * 24));
        const dateText = daysAgo === 0 ? '今天' : daysAgo === 1 ? '昨天' : `${daysAgo}天前`;
        
        return `
          <a href="./conversation-editor.html?character=${conv.character_id}&conversation=${conv.id}" class="conversation-card flex flex-col rounded-xl border border-border-light dark:border-border-dark bg-surface-light dark:bg-surface-dark shadow-sm overflow-hidden group hover:shadow-md transition-shadow cursor-pointer">
            <div class="p-6 flex-grow">
              <div class="flex items-start justify-between mb-2">
                <div class="flex-1">
                  <h3 class="text-lg font-bold text-text-light dark:text-text-dark mb-1">${conv.title || '无标题对话'}</h3>
                  <div class="flex items-center gap-2 mb-2">
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-6 border-2 border-surface-light dark:border-surface-dark" style="background-color: ${conv.character_avatar_color || '#ff6b6b'};"></div>
                    <span class="text-sm text-text-muted-light dark:text-text-muted-dark">与 ${conv.character_name || '未知角色'} 的对话</span>
                  </div>
                </div>
                <div class="flex -space-x-2">
                  <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-8 border-2 border-surface-light dark:border-surface-dark" style="background-color: ${conv.character_avatar_color || '#ff6b6b'};"></div>
                </div>
              </div>
              <p class="text-text-muted-light dark:text-text-muted-dark text-sm line-clamp-2">${conv.summary || '暂无摘要'}</p>
            </div>
            <div class="px-6 py-4 border-t border-border-light dark:border-border-dark bg-primary-subtle-light/50 dark:bg-primary-subtle-dark/50">
              <p class="text-xs text-text-muted-light dark:text-text-muted-dark">最后编辑：${dateText}</p>
            </div>
          </a>
        `;
      }).join('') + `
        <a href="./conversation-editor.html" class="group flex min-h-48 flex-col items-center justify-center gap-2 rounded-xl border-2 border-dashed border-border-light dark:border-border-dark p-6 text-center transition-colors hover:border-primary/50 hover:bg-primary-subtle-light/50 dark:hover:border-primary/50 dark:hover:bg-primary-subtle-dark/50">
          <span class="material-symbols-outlined text-4xl text-text-muted-light dark:text-text-muted-dark group-hover:text-primary transition-colors">add_circle</span>
          <h3 class="font-bold text-text-light dark:text-text-dark">创建新对话</h3>
          <p class="text-sm text-text-muted-light dark:text-text-muted-dark">从头开始一段新对话。</p>
        </a>
      `;
    }

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', () => {
      console.log('Index page loaded');
      loadStatistics();
      loadRecentConversations();
    });
  </script>
</body>
</html>
